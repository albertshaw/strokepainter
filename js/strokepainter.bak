Raphael.fn.StrokePainter=function(){function t(t){var a,o,s,h=[],e=t.splice(0,3);for(h.push("M"),h.push(e[1]),h.push(e[2]);t.length>0;)a=t.splice(0,3),o=t.splice(0,3),s=t.splice(0,3),s&&s.length?(h.push("C"),h.push(a[1]),h.push(a[2]),h.push(o[1]),h.push(o[2]),h.push(s[1]),h.push(s[2])):o&&o.length?(h.push("Q"),h.push(a[1]),h.push(a[2]),h.push(o[1]),h.push(o[2])):(h.push("L"),h.push(a[1]),h.push(a[2]));return h}function a(t,o,s){var h=!1,e=(t.y-o.y)/Math.sqrt(Math.pow(t.y-o.y,2)+Math.pow(t.x-o.x,2)),p=(o.x-t.x)/Math.sqrt(Math.pow(t.y-o.y,2)+Math.pow(t.x-o.x,2)),n=(t.x*o.y-o.x*t.y)/Math.sqrt(Math.pow(t.y-o.y,2)+Math.pow(t.x-o.x,2)),r=0,u=s.indexOf(t),f=s.indexOf(o);if(f!=u+1){for(var i={},l=[],c=u+1;f>c;c++)l.push(Math.abs(e*s[c].x+p*s[c].y+n)/Math.sqrt(Math.pow(e,2)+Math.pow(p,2)));if(r=Math.max.apply(Math,l),h=r>5?!0:!1){for(var c=u+1;f>c;c++)Math.abs(e*s[c].x+p*s[c].y+n)/Math.sqrt(Math.pow(e,2)+Math.pow(p,2))==r&&(i=s[c]);a(t,i,s),a(i,o,s)}else for(var c=u+1;f>c;c++)s[c].remove=!0}}var o=this,s=$(o.canvas),h=[],e=[],p=!1;return s.on("mousedown",function(t){e=[],e.push("M"),e.push(t.offsetX),e.push(t.offsetY);var a;p=!0,s.on("mousemove",function(t){e.push("L"),e.push(t.offsetX),e.push(t.offsetY),a||(a=o.path().attr({stroke:"#000","stroke-width":2,path:e}),h.push(a)),a.attr({path:e})})}),$(document).on("mouseup",function(){if(p){s.off("mousemove"),p=!1;var o=h[h.length-1],n=[];if(o){for(var r=0,u=0;r<e.length;)n.push({a:e[r++],x:e[r++],y:e[r++],i:u++});console.log("Before compress",e.join(",")),a(n[0],n[n.length-1],n),e=[];for(var f={},r=0;r<n.length;r++)f=n[r],f.remove||(e.push(f.a),e.push(f.x),e.push(f.y));e=t(e),console.log("After compress",e.join(",")),o.attr("path",e)}}}),o},function(){var t=window.paper=Raphael("mycanvas",800,600).StrokePainter({});$("#anim").on("click",function(){$("#mycanvas").toggleClass("anim")}),$("#filechooser").on("change",function(a){var o=a.target.files[0],s=new FileReader;s.onload=function(a){console.log(a.target),t.image(a.target.result,0,0,800,600)},s.readAsDataURL(o)})}();