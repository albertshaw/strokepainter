if("undefined"==typeof jQuery)throw new Error("StrokePainter requires jQuery");if("undefined"==typeof Raphael)throw new Error("StrokePainter requires Raphael");!function(t,e,i){var o=function(t,e){return new o.fn.init(t,e)};t.extend(o,{opts:{width:1024,height:768},tools:{},addTool:function(t,e){this.tools[t]=e},log:function(){"undefined"!=typeof console&&console.log.apply(console,arguments)}}),o.fn=o.prototype={constructor:o,init:function(i,n){var a=this;return a.context||!i?a:(a.context=t("#"+i),a.context.empty(),a.opts=t.extend(o.opts,n),a.paper=e(i,a.opts.width,a.opts.height),a.canvas=t(a.paper.canvas),a.panel=t(a.opts.panel.html()).appendTo(a.context),a.opts.tools&&a.opts.tools.length>0?t.each(a.opts.tools,function(t,e){a.register(e,o.tools[e]),a.activatedTool||a.active(e)}):t.each(o.tools,function(t,e){a.register(t,e),a.activatedTool||a.active(t)}),a.canvas.on("click",function(){a.activatedTool&&a.activatedTool.click&&a.activatedTool.click.apply(a.activatedTool,arguments)}).on("mousedown",function(){a.activatedTool&&a.activatedTool.mousedown&&a.activatedTool.mousedown.apply(a.activatedTool,arguments)}).on("mouseup",function(){a.activatedTool&&a.activatedTool.mouseup&&a.activatedTool.mouseup.apply(a.activatedTool,arguments)}).on("dbclick",function(){a.activatedTool&&a.activatedTool.dbclick&&a.activatedTool.dbclick.apply(a.activatedTool,arguments)}),this)}},o.fn.init.prototype=o.fn,t.extend(o.fn,{tools:{},register:function(e,i){t.isFunction(i)?this.tools[e]=i(this):SP.log("Tool: "+e+" not found!")},active:function(e){this.activatedTool&&e===this.activatedTool.name||(this.deactive(),this.activatedTool=this.tools[e],this.activatedTool&&t.isFunction(this.activatedTool.activated)&&this.activatedTool.activated())},deactive:function(){this.activatedTool&&t.isFunction(this.activatedTool.deactivated)&&this.activatedTool.deactivated(),this.activatedTool=""},getMouseOffsetPosition:function(t){var e=this.canvas.offset();return{left:t.pageX-e.left,top:t.pageY-e.top}}}),i.SP=i.StrokePainter=o}(jQuery,Raphael,window),function(t,e){var i=function(t){return new i.fn.init(t)};i.fn=i.prototype={constructor:i,name:"brush",init:function(e){var i=this;i.painter=e,i.icon=t('<a class="sp-panel-icon" href="javascript:;" title="画笔"><svg class="icon-pencil"><use xlink:href="#icon-pencil"></use></svg></a>'),e.panel.find(".sp-panel-content").append(i.icon),i.icon.on("click",function(){i.icon.is(".active")?i.painter.deactive("brush"):i.painter.active("brush")})}},i.fn.init.prototype=i.fn,t.extend(i.fn,{activated:function(){this.icon.addClass("active")},deactivated:function(){this.painter.canvas.off(".strokepainter.brush"),this.icon.removeClass("active")},mousedown:function(t){if(!this.painting){this.painting=!0;var e,i=this,o=this.painter.getMouseOffsetPosition(t),n=["M",o.left,o.top];this.painter.canvas.on("mousemove.strokepainter.brush",function(t){var o=i.painter.getMouseOffsetPosition(t);n.push("L"),n.push(o.left),n.push(o.top),e||(e=i.painter.paper.path().attr({stroke:"#000","stroke-width":2,path:n})),e.attr({path:n})})}},mouseup:function(){this.painting&&(this.painting=!1,this.painter.canvas.off("mousemove.strokepainter.brush"))}}),e.addTool("brush",i)}(jQuery,StrokePainter),function(t,e){var i=function(t){return new i.fn.init(t)};i.fn=i.prototype={constructor:i,name:"chooser",init:function(e){var i=this;i.painter=e,i.icon=t('<a class="sp-panel-icon" href="javascript:;" title="选择"><svg class="icon-target"><use xlink:href="#icon-target"></use></svg></a>'),e.panel.find(".sp-panel-content").append(i.icon),i.icon.click(function(){i.icon.is(".active")?i.painter.deactive("chooser"):i.painter.active("chooser")})}},i.fn.init.prototype=i.fn;var o='<div class="sp-subpanel-section"><input type="text" value="5"/><a title="路径点抽稀" class="sp-panel-icon" href="javascript:;"><svg class="icon-statistics"><use xlink:href="#icon-statistics"></use></svg></a></div>';t.extend(i.fn,{subpanel:o,compress:function(){if(this.selected){var t=this.selected.node.getAttribute("d");if(t){for(var e=t.split(/\D+/).slice(1),i=[],o=0,n=0;o<e.length;)i.push({x:e[o++],y:e[o++],i:n++});this.dp(i[0],i[i.length-1],i),e=[];for(var o=0;o<i.length;o++){var a=i[o];a.remove||(e.push(0==o?"M":"L"),e.push(a.x),e.push(a.y))}this.selected.attr("path",e)}}},dp:function(t,e,i){var o=(t.y-e.y)/Math.sqrt(Math.pow(t.y-e.y,2)+Math.pow(t.x-e.x,2)),n=(e.x-t.x)/Math.sqrt(Math.pow(t.y-e.y,2)+Math.pow(t.x-e.x,2)),a=(t.x*e.y-e.x*t.y)/Math.sqrt(Math.pow(t.y-e.y,2)+Math.pow(t.x-e.x,2)),s=t.i,c=e.i;if(c!=s+1){for(var r=0,p={},h=0,l=s+1;c>l;l++){var u=i[l];h=Math.abs(o*u.x+n*u.y+a)/Math.sqrt(Math.pow(o,2)+Math.pow(n,2)),h>r&&(r=h,p=u)}if(r<=this.threshold)for(var l=s+1;c>l;l++)i[l].remove=!0;else this.dp(t,p,i),this.dp(p,e,i)}},activated:function(){var e=this;e.painter.canvas.on("mouseover.strokepainter.chooser","path",function(){if(e.selected&&e.selected.node==this)return!1;var t=new Raphael.el.constructor(this,e.painter.paper);t.type="path",e.hovered=t,e.highlight(t)}).on("mouseleave.strokepainter.chooser","path",function(){e.resume(e.hovered),e.hovered=null}),e.painter.panel.find(".sp-subpanel").on("click",".sp-panel-icon svg",function(){var i=t(this);i.is(".icon-statistics")&&(e.threshold=i.parent().siblings("input").val()||1,e.compress())}).html(e.subpanel).removeClass("hidden").slideDown(),e.icon.addClass("active")},deactivated:function(){this.painter.canvas.off(".strokepainter.chooser"),this.painter.panel.find(".sp-subpanel").slideUp(),this.resume(this.hovered),this.resume(this.selected),this.hovered=null,this.selected=null,this.icon.removeClass("active")},click:function(){this.hovered&&(this.resume(this.selected),this.selected=this.hovered,this.hovered=null)},highlight:function(t){t&&t.attr({"stroke-width":6})},resume:function(t){t&&t.attr({"stroke-width":2})}}),e.addTool("chooser",i)}(jQuery,StrokePainter),function(t,e){var i=function(t){return new i.fn.init(t)};i.fn=i.prototype={constructor:i,name:"preview",init:function(i){var o=this;o.painter=i,o.icon=t('<a class="sp-panel-icon" href="javascript:;" title="预览"><svg class="icon-eye"><use xlink:href="#icon-eye"></use></svg></a>'),i.panel.find(".sp-panel-content").append(o.icon),o.icon.click(function(){e.log(o.painter.canvas[0].outerHTML),o.painter.active("preview");var t=o.painter.canvas.find("path");t.each(function(){var t=this.getTotalLength();this.style.transition=this.style.WebkitTransition="none",this.style.strokeDasharray=t+" "+t,this.style.strokeDashoffset=t,this.getBoundingClientRect(),this.style.transition=this.style.WebkitTransition="stroke-dashoffset 2s ease-in-out",this.style.strokeDashoffset="0"}),o.painter.deactive("preview")})}},i.fn.init.prototype=i.fn,t.extend(i.fn,{activated:function(){this.icon.addClass("active")},deactivated:function(){this.icon.removeClass("active")}}),e.addTool("preview",i)}(jQuery,StrokePainter);